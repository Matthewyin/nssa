name: Deploy NSSA to Cloudflare Workers

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to Cloudflare Workers
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true  # å¦‚æœä½¿ç”¨äº†Hugoä¸»é¢˜å­æ¨¡å—
          fetch-depth: 0    # è·å–å®Œæ•´å†å²è®°å½•

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: 'latest'
          extended: true

      - name: Install dependencies
        run: npm ci

      - name: Build Hugo site
        run: npm run build

      - name: Validate Worker code
        run: |
          echo "ğŸ” éªŒè¯Workerä»£ç ..."
          if [ ! -f "workers-site/index.js" ]; then
            echo "âŒ Workeræ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          
          # æ£€æŸ¥AdminåŠŸèƒ½
          if grep -q "handleAdminRequest" workers-site/index.js && \
             grep -q "handleAdminInterface" workers-site/index.js && \
             grep -q "getAdminHTML" workers-site/index.js; then
            echo "âœ… AdminåŠŸèƒ½å·²é›†æˆ"
          else
            echo "âŒ AdminåŠŸèƒ½ç¼ºå¤±"
            exit 1
          fi

      - name: Deploy to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy

      - name: Verify deployment
        run: |
          echo "ğŸ” éªŒè¯éƒ¨ç½²ç»“æœ..."
          
          # ç­‰å¾…éƒ¨ç½²ç”Ÿæ•ˆ
          sleep 10
          
          # æµ‹è¯•ä¸»ç«™
          echo "æµ‹è¯•ä¸»ç«™..."
          curl -f "https://nssa.io" > /dev/null || echo "âš ï¸ ä¸»ç«™è®¿é—®å¼‚å¸¸"
          
          # æµ‹è¯•ä¸»ç«™API
          echo "æµ‹è¯•ä¸»ç«™API..."
          response=$(curl -s "https://nssa.io/api/views/get?path=/test")
          if echo "$response" | grep -q "views"; then
            echo "âœ… ä¸»ç«™APIæ­£å¸¸"
          else
            echo "âš ï¸ ä¸»ç«™APIå¼‚å¸¸: $response"
          fi
          
          # æµ‹è¯•Adminç•Œé¢
          echo "æµ‹è¯•Adminç•Œé¢..."
          curl -f "https://admin.nssa.io" > /dev/null || echo "âš ï¸ Adminç•Œé¢è®¿é—®å¼‚å¸¸"
          
          # æµ‹è¯•Admin API
          echo "æµ‹è¯•Admin API..."
          admin_response=$(curl -s "https://admin.nssa.io/api/health")
          if echo "$admin_response" | grep -q "success"; then
            echo "âœ… Admin APIæ­£å¸¸"
          else
            echo "âš ï¸ Admin APIå¼‚å¸¸: $admin_response"
          fi

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
            echo "ğŸŒ ä¸»ç«™: https://nssa.io"
            echo "ğŸ”§ ç®¡ç†åå°: https://admin.nssa.io"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
          fi

  # å¯é€‰ï¼šä»…åœ¨PRæ—¶è¿è¡Œé¢„è§ˆéƒ¨ç½²
  preview:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    name: Deploy Preview
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: 'latest'
          extended: true

      - name: Install dependencies
        run: npm ci

      - name: Build Hugo site
        run: npm run build

      - name: Deploy Preview
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy --env preview
          
      - name: Comment PR
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ğŸš€ é¢„è§ˆéƒ¨ç½²å®Œæˆï¼
              
              ğŸ“± é¢„è§ˆé“¾æ¥:
              - ä¸»ç«™: https://nssa-preview.your-subdomain.workers.dev
              - ç®¡ç†åå°: https://admin-nssa-preview.your-subdomain.workers.dev
              
              â° éƒ¨ç½²æ—¶é—´: ${new Date().toLocaleString('zh-CN', {timeZone: 'Asia/Shanghai'})}
              ğŸ“ æäº¤: ${context.sha.substring(0, 7)}`
            })

---
import SearchSimple from '../components/SearchSimple.astro';
import '../styles/global.css';
import { getLangFromUrl, t, getAlternateLanguagePaths, type Language } from '../utils/i18n';

export interface Props {
  title: string;
  description?: string;
  image?: string;
  lang?: Language;
}

const currentLang = Astro.props.lang || getLangFromUrl(Astro.url);
const { title, description = t('home.description', currentLang), image } = Astro.props;
const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const alternateLanguages = getAlternateLanguagePaths(Astro.url.pathname, currentLang);
---

<!doctype html>
<html lang={currentLang === 'zh' ? 'zh-CN' : 'en-US'}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content={Astro.generator} />

    <!-- SEO Meta Tags -->
    <title>{title}</title>
    <meta name="description" content={description} />
    <meta name="keywords" content={currentLang === 'zh' ? '历史研究,战略分析,交互式学习,学术平台' : 'historical research,strategic analysis,interactive learning,academic platform'} />
    <meta name="author" content="NSSA Team" />
    <link rel="canonical" href={canonicalURL} />

    <!-- Alternate Language Links -->
    {Object.entries(alternateLanguages).map(([lang, path]) => (
      <link rel="alternate" hreflang={lang} href={new URL(path, Astro.site)} />
    ))}
    <link rel="alternate" hreflang="x-default" href={new URL(currentLang === 'zh' ? Astro.url.pathname : alternateLanguages.zh || '/', Astro.site)} />
    
    <!-- Open Graph -->
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:site_name" content="NSSA - Network-System-Security-Application" />
    {image && <meta property="og:image" content={image} />}
    
    <!-- Twitter Cards -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    {image && <meta name="twitter:image" content={image} />}
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="alternate icon" type="image/x-icon" href="/favicon.svg" />
    
    <!-- Fonts and Styles -->
    <style>
      .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
      .line-clamp-3 {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
      
      /* Apple-style variables */
      :root {
        --apple-blue: #007AFF;
        --apple-gray: #8E8E93;
      }
      
      .text-apple-blue {
        color: var(--apple-blue);
      }
      
      .text-apple-gray {
        color: var(--apple-gray);
      }
      
      .content-card {
        @apply bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600 transition-all duration-200 hover:shadow-lg;
      }
    </style>
  </head>
  
  <body class="bg-white dark:bg-gray-900 transition-colors duration-300">
    <!-- Navigation -->
    <nav class="bg-white/80 backdrop-blur-md border-b border-gray-200 sticky top-0 z-50 dark:bg-gray-900/80 dark:border-gray-700">
      <div class="max-w-7xl mx-auto px-6">
        <div class="flex items-center justify-between h-16">
          <!-- Logo -->
          <div class="flex items-center space-x-8">
            <a href="/" class="flex items-center">
              <img src="/logo.svg" alt="NSSA" class="h-8 w-auto" />
            </a>
            
            <!-- Desktop Navigation -->
            <div class="hidden lg:flex items-center space-x-6">
              <a href={currentLang === 'zh' ? '/business/' : '/en/business/'} class="nav-link text-gray-700 dark:text-gray-300 hover:text-apple-blue dark:hover:text-blue-400 transition-colors">
                {t('nav.business', currentLang)}
              </a>
              <a href={currentLang === 'zh' ? '/tech/' : '/en/tech/'} class="nav-link text-gray-700 dark:text-gray-300 hover:text-apple-blue dark:hover:text-blue-400 transition-colors">
                {t('nav.tech', currentLang)}
              </a>
              <a href={currentLang === 'zh' ? '/psychology/' : '/en/psychology/'} class="nav-link text-gray-700 dark:text-gray-300 hover:text-apple-blue dark:hover:text-blue-400 transition-colors">
                {t('nav.psychology', currentLang)}
              </a>
              <a href={currentLang === 'zh' ? '/workplace/' : '/en/workplace/'} class="nav-link text-gray-700 dark:text-gray-300 hover:text-apple-blue dark:hover:text-blue-400 transition-colors">
                {t('nav.workplace', currentLang)}
              </a>
              <a href={currentLang === 'zh' ? '/history/' : '/en/history/'} class="nav-link text-gray-700 dark:text-gray-300 hover:text-apple-blue dark:hover:text-blue-400 transition-colors">
                {t('nav.history', currentLang)}
              </a>
              <a href={currentLang === 'zh' ? '/about/' : '/en/about/'} class="nav-link text-gray-700 dark:text-gray-300 hover:text-apple-blue dark:hover:text-blue-400 transition-colors">
                {t('nav.about', currentLang)}
              </a>
            </div>
          </div>
          
          <!-- Right side controls -->
          <div class="flex items-center space-x-4">
            <!-- Search -->
            <div class="hidden md:block relative">
              <div class="relative">
                <input
                  type="text"
                  id="search-input"
                  placeholder={t('nav.search.placeholder', currentLang)}
                  class="w-64 px-4 py-2 pl-10 pr-4 text-sm bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-apple-blue dark:focus:ring-blue-400 focus:border-transparent dark:text-white dark:placeholder-gray-400"
                />
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <svg class="h-4 w-4 text-gray-400 dark:text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5A7 7 0 113 10a7 7 0 0114 0z"/>
                  </svg>
                </div>
              </div>

              <!-- Desktop Search Results -->
              <div id="search-results" class="hidden absolute top-full left-0 right-0 mt-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg z-50 max-h-96 overflow-y-auto min-w-96">
                <div id="search-results-content" class="p-2">
                  <!-- 搜索结果将在这里显示 -->
                </div>
              </div>
            </div>
            
            <!-- Language Toggle -->
            <div class="relative">
              <button 
                id="language-toggle" 
                class="p-2 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg transition-colors" 
                title="切换语言"
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022.0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"/>
                </svg>
              </button>
              <div id="language-menu" class="hidden absolute right-0 mt-2 w-32 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 z-50">
                {currentLang === 'zh' ? (
                  <a href="/en" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 first:rounded-t-lg last:rounded-b-lg">
                    English
                  </a>
                ) : (
                  <a href="/" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 first:rounded-t-lg last:rounded-b-lg">
                    中文
                  </a>
                )}
              </div>
            </div>
            
            <!-- Theme Toggle -->
            <button 
              id="theme-toggle" 
              class="p-2 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg transition-colors" 
              title="切换主题"
            >
              <svg id="theme-toggle-light-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1A1 1 0 119 4V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707A1 1 0 1113.536 5.05l.707-.707a1 1 0 011.414.0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707A1 1 0 004.343 5.757l.707.707zm1.414 8.486-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"/>
              </svg>
              <svg id="theme-toggle-dark-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20">
                <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001.0 1010.586 10.586z"/>
              </svg>
              <svg id="theme-toggle-system-icon" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M3 5a2 2 0 012-2h10a2 2 0 012 2v8a2 2 0 01-2 2h-2.22l.123.489.804.804A1 1 0 0113 18H7a1 1 0 01-.707-1.707l.804-.804L7.22 15H5a2 2 0 01-2-2V5zm5.771 7H5V5h10v7H8.771z" clip-rule="evenodd"/>
              </svg>
            </button>
            
            <!-- Mobile Menu Button -->
            <button class="lg:hidden p-2 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg transition-colors" onclick="toggleMobileMenu()">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
              </svg>
            </button>
          </div>
        </div>
        
        <!-- Mobile Menu -->
        <div id="mobile-menu" class="lg:hidden hidden border-t border-gray-200 dark:border-gray-700 py-4">
          <div class="mb-4 md:hidden">
            <div class="relative">
              <input 
                type="text" 
                id="mobile-search-input" 
                placeholder="搜索..." 
                class="w-full px-4 py-2 pl-10 pr-4 text-sm bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-apple-blue dark:focus:ring-blue-400 focus:border-transparent dark:text-white dark:placeholder-gray-400"
              />
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <svg class="h-4 w-4 text-gray-400 dark:text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5A7 7 0 113 10a7 7 0 0114 0z"/>
                </svg>
              </div>
            </div>

            <!-- Mobile Search Results -->
            <div id="mobile-search-results" class="hidden mt-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg max-h-96 overflow-y-auto">
              <div id="mobile-search-results-content" class="p-2">
                <!-- 移动端搜索结果将在这里显示 -->
              </div>
            </div>
          </div>
          
          <a href="/business/" class="block py-3 px-2 nav-link text-gray-700 dark:text-gray-300 hover:text-apple-blue dark:hover:text-blue-400 hover:bg-gray-50 dark:hover:bg-gray-800 rounded-lg transition-colors">
            业务专题
          </a>
          <a href="/tech/" class="block py-3 px-2 nav-link text-gray-700 dark:text-gray-300 hover:text-apple-blue dark:hover:text-blue-400 hover:bg-gray-50 dark:hover:bg-gray-800 rounded-lg transition-colors">
            技术专题
          </a>
          <a href="/psychology/" class="block py-3 px-2 nav-link text-gray-700 dark:text-gray-300 hover:text-apple-blue dark:hover:text-blue-400 hover:bg-gray-50 dark:hover:bg-gray-800 rounded-lg transition-colors">
            心理专题
          </a>
          <a href="/workplace/" class="block py-3 px-2 nav-link text-gray-700 dark:text-gray-300 hover:text-apple-blue dark:hover:text-blue-400 hover:bg-gray-50 dark:hover:bg-gray-800 rounded-lg transition-colors">
            职场专题
          </a>
          <a href="/history/" class="block py-3 px-2 nav-link text-gray-700 dark:text-gray-300 hover:text-apple-blue dark:hover:text-blue-400 hover:bg-gray-50 dark:hover:bg-gray-800 rounded-lg transition-colors">
            历史专题
          </a>
          <a href="/about/" class="block py-3 px-2 nav-link text-gray-700 dark:text-gray-300 hover:text-apple-blue dark:hover:text-blue-400 hover:bg-gray-50 dark:hover:bg-gray-800 rounded-lg transition-colors">
            关于
          </a>
        </div>
      </div>
    </nav>
    
    <!-- Search Component -->
    <SearchSimple />

    <!-- Main Content -->
    <slot />

    <!-- Footer -->
    <footer class="border-t border-gray-200 mt-20 dark:border-gray-700">
      <div class="max-w-6xl mx-auto px-6 py-12">
        <!-- 友情链接区域 -->
        <div class="mb-12">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-white text-center mb-8">
            🚀 {t('footer.ecosystem_title', currentLang)}
          </h3>
          <p class="text-apple-gray text-center mb-8 max-w-2xl mx-auto">
            {t('footer.ecosystem_description', currentLang)}
          </p>

          <!-- 友情链接网格 -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6">
            <!-- 灵感墙 -->
            <a href="https://inspirista.nssa.io"
               target="_blank"
               rel="noopener noreferrer"
               class="content-card p-6 text-center group block hover:no-underline">
              <div class="text-3xl mb-3">💡</div>
              <h4 class="font-semibold text-gray-900 dark:text-white mb-2 group-hover:text-apple-blue transition-colors">
                {t('footer.inspirista', currentLang)}
              </h4>
              <p class="text-apple-gray text-sm mb-4">
                {t('footer.inspirista_desc', currentLang)}
              </p>
            </a>

            <!-- 练功房 -->
            <a href="https://sf.nssa.io"
               target="_blank"
               rel="noopener noreferrer"
               class="content-card p-6 text-center group block hover:no-underline">
              <div class="text-3xl mb-3">🥋</div>
              <h4 class="font-semibold text-gray-900 dark:text-white mb-2 group-hover:text-apple-blue transition-colors">
                {t('footer.sf', currentLang)}
              </h4>
              <p class="text-apple-gray text-sm mb-4">
                {t('footer.sf_desc', currentLang)}
              </p>
            </a>

            <!-- 工具箱 -->
            <a href="https://tools.nssa.io"
               target="_blank"
               rel="noopener noreferrer"
               class="content-card p-6 text-center group block hover:no-underline">
              <div class="text-3xl mb-3">🛠️</div>
              <h4 class="font-semibold text-gray-900 dark:text-white mb-2 group-hover:text-apple-blue transition-colors">
                {t('footer.tools', currentLang)}
              </h4>
              <p class="text-apple-gray text-sm mb-4">
                {t('footer.tools_desc', currentLang)}
              </p>
            </a>

            <!-- 游戏室 -->
            <a href="https://games.nssa.io"
               target="_blank"
               rel="noopener noreferrer"
               class="content-card p-6 text-center group block hover:no-underline">
              <div class="text-3xl mb-3">🎮</div>
              <h4 class="font-semibold text-gray-900 dark:text-white mb-2 group-hover:text-apple-blue transition-colors">
                {t('footer.games', currentLang)}
              </h4>
              <p class="text-apple-gray text-sm mb-4">
                {t('footer.games_desc', currentLang)}
              </p>
            </a>
          </div>
        </div>

        <!-- Bottom Footer -->
        <div class="border-t border-gray-200 dark:border-gray-700 pt-8">
          <div class="flex flex-col md:flex-row justify-between items-center">
            <div class="text-center md:text-left mb-4 md:mb-0">
              <p class="text-apple-gray text-sm mb-1">{t('footer.copyright', currentLang)}</p>
              <p class="text-apple-gray text-xs">Powered by Astro | Domain: nssa.io</p>
            </div>

            <div class="flex items-center space-x-6 text-sm text-gray-500 dark:text-gray-400">
              <a href="/sitemap-index.xml" class="hover:text-apple-blue dark:hover:text-blue-400 transition-colors">{t('footer.sitemap', currentLang)}</a>
              <a href={currentLang === 'zh' ? '/rss.xml' : '/en/rss.xml'} class="hover:text-apple-blue dark:hover:text-blue-400 transition-colors">{t('footer.rss', currentLang)}</a>
              <div class="flex items-center space-x-2">
                <span>{t('footer.language', currentLang)}:</span>
                {currentLang === 'zh' ? (
                  <>
                    <span class="text-apple-blue">中文</span>
                    <span>|</span>
                    <a href="/en/" class="hover:text-apple-blue dark:hover:text-blue-400 transition-colors">English</a>
                  </>
                ) : (
                  <>
                    <a href="/" class="hover:text-apple-blue dark:hover:text-blue-400 transition-colors">中文</a>
                    <span>|</span>
                    <span class="text-apple-blue">English</span>
                  </>
                )}
              </div>
            </div>
          </div>
        </div>
      </div>
    </footer>
    
    <!-- Scripts -->
    <script>
      // Theme toggle functionality
      function initThemeToggle() {
        const themeToggle = document.getElementById('theme-toggle');
        const lightIcon = document.getElementById('theme-toggle-light-icon');
        const darkIcon = document.getElementById('theme-toggle-dark-icon');
        const systemIcon = document.getElementById('theme-toggle-system-icon');
        
        let currentTheme = localStorage.getItem('theme') || 'system';
        
        function setTheme(theme) {
          lightIcon.classList.add('hidden');
          darkIcon.classList.add('hidden');
          systemIcon.classList.add('hidden');
          
          if (theme === 'dark') {
            document.documentElement.classList.add('dark');
            lightIcon.classList.remove('hidden');
            localStorage.setItem('theme', 'dark');
          } else if (theme === 'light') {
            document.documentElement.classList.remove('dark');
            darkIcon.classList.remove('hidden');
            localStorage.setItem('theme', 'light');
          } else {
            systemIcon.classList.remove('hidden');
            localStorage.setItem('theme', 'system');
            if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
              document.documentElement.classList.add('dark');
            } else {
              document.documentElement.classList.remove('dark');
            }
          }
        }
        
        // Listen for system theme changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
          if (localStorage.getItem('theme') === 'system') {
            if (e.matches) {
              document.documentElement.classList.add('dark');
            } else {
              document.documentElement.classList.remove('dark');
            }
          }
        });
        
        setTheme(currentTheme);
        
        themeToggle.addEventListener('click', function() {
          const currentTheme = localStorage.getItem('theme') || 'system';
          let nextTheme;
          
          if (currentTheme === 'system') {
            nextTheme = 'light';
          } else if (currentTheme === 'light') {
            nextTheme = 'dark';
          } else {
            nextTheme = 'system';
          }
          
          setTheme(nextTheme);
        });
      }
      
      // Mobile menu toggle (global function)
      window.toggleMobileMenu = function() {
        const mobileMenu = document.getElementById('mobile-menu');
        if (mobileMenu) {
          mobileMenu.classList.toggle('hidden');
        }
      }
      
      // Language toggle
      function initLanguageToggle() {
        const languageToggle = document.getElementById('language-toggle');
        const languageMenu = document.getElementById('language-menu');
        
        if (languageToggle && languageMenu) {
          languageToggle.addEventListener('click', function(e) {
            e.stopPropagation();
            languageMenu.classList.toggle('hidden');
          });
          
          document.addEventListener('click', function() {
            languageMenu.classList.add('hidden');
          });
          
          languageMenu.addEventListener('click', function(e) {
            e.stopPropagation();
          });
        }
      }
      
      // Initialize on DOM load
      document.addEventListener('DOMContentLoaded', function() {
        initThemeToggle();
        initLanguageToggle();
      });
    </script>
  </body>
</html>

---
import Layout from '../../layouts/Layout.astro';
import { getPostBySlug, getAllPosts } from '../../lib/github';
import { marked } from 'marked';

// 获取slug参数
const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect('/404');
}

// 动态获取文章内容
const post = await getPostBySlug(slug);

if (!post) {
  return Astro.redirect('/404');
}

// 渲染markdown内容
const htmlContent = marked(post.content);

// 格式化日期
function formatDate(date: Date): string {
  return date.toLocaleDateString('zh-CN', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
}

// 获取相关文章（同分类的其他文章）
const allPosts = await getAllPosts();
const relatedPosts = allPosts
  .filter(p => p.slug !== post.slug && p.category === post.category)
  .slice(0, 3);
---

<Layout title={`${post.title} - NSSA`} description={post.description}>
  <main class="container mx-auto px-4 py-8 max-w-4xl">
    <!-- 返回链接 -->
    <nav class="mb-8">
      <a 
        href="/posts/" 
        class="inline-flex items-center text-apple-blue hover:text-blue-600 transition-colors"
      >
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
        </svg>
        返回文章列表
      </a>
    </nav>

    <!-- 文章头部 -->
    <header class="mb-12">
      <div class="mb-4">
        <span class="inline-block px-3 py-1 text-sm font-medium text-apple-blue bg-blue-50 dark:bg-blue-900/20 rounded-full">
          {post.category}
        </span>
      </div>
      
      <h1 class="text-4xl sm:text-5xl font-bold text-gray-900 dark:text-white mb-6 leading-tight">
        {post.title}
      </h1>
      
      {post.description && (
        <p class="text-xl text-apple-gray mb-6 leading-relaxed">
          {post.description}
        </p>
      )}
      
      <div class="flex flex-wrap items-center gap-4 text-apple-gray">
        <time datetime={post.pubDate.toISOString()} class="flex items-center">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
          </svg>
          {formatDate(post.pubDate)}
        </time>
        
        {post.author && (
          <span class="flex items-center">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
            </svg>
            {post.author}
          </span>
        )}
      </div>
      
      {post.tags.length > 0 && (
        <div class="flex flex-wrap gap-2 mt-4">
          {post.tags.map((tag) => (
            <span class="text-sm px-3 py-1 bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400 rounded-full">
              #{tag}
            </span>
          ))}
        </div>
      )}
    </header>

    <!-- 文章图片 -->
    {post.image && (
      <div class="mb-12">
        <img 
          src={post.image} 
          alt={post.title}
          class="w-full h-64 sm:h-96 object-cover rounded-xl shadow-lg"
        />
      </div>
    )}

    <!-- 文章内容 -->
    <article class="prose prose-lg dark:prose-invert max-w-none mb-16">
      <div set:html={htmlContent} />
    </article>

    <!-- 相关文章 -->
    {relatedPosts.length > 0 && (
      <section class="border-t border-gray-200 dark:border-gray-700 pt-12">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-8">
          相关文章
        </h2>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          {relatedPosts.map((relatedPost) => (
            <article class="content-card group">
              <a href={`/posts/${relatedPost.slug}/`} class="block p-6">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2 group-hover:text-apple-blue dark:group-hover:text-blue-400 transition-colors line-clamp-2">
                  {relatedPost.title}
                </h3>
                
                <p class="text-apple-gray text-sm mb-3 line-clamp-2">
                  {relatedPost.description}
                </p>
                
                <time datetime={relatedPost.pubDate.toISOString()} class="text-xs text-apple-gray">
                  {formatDate(relatedPost.pubDate)}
                </time>
              </a>
            </article>
          ))}
        </div>
      </section>
    )}
  </main>
</Layout>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  /* 自定义prose样式 */
  .prose {
    @apply text-gray-900 dark:text-gray-100;
  }
  
  .prose h1, .prose h2, .prose h3, .prose h4, .prose h5, .prose h6 {
    @apply text-gray-900 dark:text-white;
  }
  
  .prose a {
    @apply text-apple-blue hover:text-blue-600 no-underline;
  }
  
  .prose code {
    @apply bg-gray-100 dark:bg-gray-800 px-1 py-0.5 rounded text-sm;
  }
  
  .prose pre {
    @apply bg-gray-100 dark:bg-gray-800 rounded-lg p-4;
  }
  
  .prose blockquote {
    @apply border-l-4 border-apple-blue bg-blue-50 dark:bg-blue-900/20 pl-4 py-2 my-6;
  }
</style>

---
import Layout from '../../layouts/Layout.astro';
import { getAllPosts } from '../../lib/github';

// 动态获取所有文章
const allPosts = await getAllPosts();

// 分页参数
const currentPage = parseInt(Astro.url.searchParams.get('page') || '1');
const postsPerPage = 12;
const totalPages = Math.ceil(allPosts.length / postsPerPage);
const startIndex = (currentPage - 1) * postsPerPage;
const endIndex = startIndex + postsPerPage;
const currentPosts = allPosts.slice(startIndex, endIndex);

// 格式化日期
function formatDate(date: Date): string {
  return date.toLocaleDateString('zh-CN', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
}
---

<Layout title="所有文章 - NSSA">
  <main class="container mx-auto px-4 py-8 max-w-6xl">
    <!-- 页面标题 -->
    <div class="text-center mb-12">
      <h1 class="text-4xl sm:text-5xl font-bold text-gray-900 dark:text-white mb-4">
        所有文章
      </h1>
      <p class="text-xl text-apple-gray max-w-2xl mx-auto">
        共 {allPosts.length} 篇文章，探索各个领域的深度思考
      </p>
    </div>

    <!-- 文章网格 -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mb-12">
      {currentPosts.map((post) => (
        <article class="content-card group">
          <a href={`/posts/${post.slug}/`} class="block p-6 h-full">
            {post.image && (
              <div class="mb-4 overflow-hidden rounded-lg">
                <img 
                  src={post.image} 
                  alt={post.title}
                  class="w-full h-48 object-cover group-hover:scale-105 transition-transform duration-300"
                />
              </div>
            )}
            
            <div class="flex flex-col h-full">
              <div class="mb-3">
                <span class="inline-block px-3 py-1 text-sm font-medium text-apple-blue bg-blue-50 dark:bg-blue-900/20 rounded-full">
                  {post.category}
                </span>
              </div>
              
              <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-3 group-hover:text-apple-blue dark:group-hover:text-blue-400 transition-colors line-clamp-2">
                {post.title}
              </h2>
              
              <p class="text-apple-gray mb-4 flex-grow line-clamp-3">
                {post.description}
              </p>
              
              <div class="flex items-center justify-between text-sm text-apple-gray">
                <time datetime={post.pubDate.toISOString()}>
                  {formatDate(post.pubDate)}
                </time>
                {post.author && (
                  <span>by {post.author}</span>
                )}
              </div>
              
              {post.tags.length > 0 && (
                <div class="flex flex-wrap gap-2 mt-3">
                  {post.tags.slice(0, 3).map((tag) => (
                    <span class="text-xs px-2 py-1 bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400 rounded">
                      #{tag}
                    </span>
                  ))}
                </div>
              )}
            </div>
          </a>
        </article>
      ))}
    </div>

    <!-- 分页导航 -->
    {totalPages > 1 && (
      <nav class="flex justify-center items-center space-x-2">
        {currentPage > 1 && (
          <a 
            href={`/posts/?page=${currentPage - 1}`}
            class="px-4 py-2 text-apple-blue hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded-lg transition-colors"
          >
            上一页
          </a>
        )}
        
        {Array.from({ length: totalPages }, (_, i) => i + 1).map((page) => (
          <a 
            href={`/posts/?page=${page}`}
            class={`px-4 py-2 rounded-lg transition-colors ${
              page === currentPage 
                ? 'bg-apple-blue text-white' 
                : 'text-apple-gray hover:bg-gray-100 dark:hover:bg-gray-800'
            }`}
          >
            {page}
          </a>
        ))}
        
        {currentPage < totalPages && (
          <a 
            href={`/posts/?page=${currentPage + 1}`}
            class="px-4 py-2 text-apple-blue hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded-lg transition-colors"
          >
            下一页
          </a>
        )}
      </nav>
    )}
  </main>
</Layout>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
